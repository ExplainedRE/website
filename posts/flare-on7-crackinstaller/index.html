<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Flare-On 7 — 09 crackinstaller - explained.re</title><meta name=Description content><meta property="og:title" content="Flare-On 7 — 09 crackinstaller"><meta property="og:description" content="Challenge Description  What kind of crackme doesn&rsquo;t even ask for the password? We need to work on our COMmunication skills.   In this challenge we get a 64 bit Windows executable, off to a good start.
 The challenge description has a clue for the possible usage of COM objects here, so we&rsquo;ll make a mental note of that.
Simply executing the binary doesn&rsquo;t seem to do much, so we&rsquo;ll fire up a debugger and start looking at the code."><meta property="og:type" content="article"><meta property="og:url" content="https://explained.re/posts/flare-on7-crackinstaller/"><meta property="og:image" content="https://explained.re/images/explained_dark.png"><meta property="article:published_time" content="2020-10-23T21:29:49+03:00"><meta property="article:modified_time" content="2020-10-23T21:29:49+03:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://explained.re/images/explained_dark.png"><meta name=twitter:title content="Flare-On 7 — 09 crackinstaller"><meta name=twitter:description content="Challenge Description  What kind of crackme doesn&rsquo;t even ask for the password? We need to work on our COMmunication skills.   In this challenge we get a 64 bit Windows executable, off to a good start.
 The challenge description has a clue for the possible usage of COM objects here, so we&rsquo;ll make a mental note of that.
Simply executing the binary doesn&rsquo;t seem to do much, so we&rsquo;ll fire up a debugger and start looking at the code."><meta name=application-name content="explained.re"><meta name=apple-mobile-web-app-title content="explained.re"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://explained.re/posts/flare-on7-crackinstaller/><link rel=prev href=https://explained.re/posts/flare-on7-aardvark/><link rel=next href=https://explained.re/posts/flare-on-7-break/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Flare-On 7 — 09 crackinstaller","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/explained.re\/posts\/flare-on7-crackinstaller\/"},"genre":"posts","keywords":"flare-on","wordcount":3908,"url":"https:\/\/explained.re\/posts\/flare-on7-crackinstaller\/","datePublished":"2020-10-23T21:29:49+03:00","dateModified":"2020-10-23T21:29:49+03:00","publisher":{"@type":"Organization","name":"explained.re"},"author":{"@type":"Person","name":"explained.re"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('dark'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'dark'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=explained.re><img class="lazyload logo" src=/svg/loading.min.svg data-src=/images/explained.svg data-srcset="/images/explained.svg, /images/explained.svg 1.5x, /images/explained.svg 2x" data-sizes=auto alt=/images/explained.svg title=/images/explained.svg></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About </a><a class=menu-item href=https://github.com/explainedre/website title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=explained.re><img class="lazyload logo" src=/svg/loading.min.svg data-src=/images/explained.svg data-srcset="/images/explained.svg, /images/explained.svg 1.5x, /images/explained.svg 2x" data-sizes=auto alt=/images/explained.svg title=/images/explained.svg></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/>Posts</a><a class=menu-item href=/tags/>Tags</a><a class=menu-item href=/categories/>Categories</a><a class=menu-item href=/about/>About</a><a class=menu-item href=https://github.com/explainedre/website title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><article class="page single"><h1 class="single-title animated flipInX">Flare-On 7 — 09 crackinstaller</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>explained.re</a></span>&nbsp;<span class=post-category>included in <a href=/categories/write-up/><i class="far fa-folder fa-fw"></i>write-up</a>&nbsp;<a href=/categories/ctf/><i class="far fa-folder fa-fw"></i>ctf</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2020-10-23>2020-10-23</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;3908 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;19 minutes&nbsp;</div></div><div class=content id=content><div class="details admonition info open"><div class="details-summary admonition-title"><i class="icon fas fa-info-circle fa-fw"></i>Challenge Description<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>What kind of crackme doesn&rsquo;t even ask for the password? We need to work on our COMmunication skills.</div></div></div><p>In this challenge we get a 64 bit Windows executable, off to a good start.</p><a class=lightgallery href=/posts/flare-on7-crackinstaller/images/image.png title=/posts/flare-on7-crackinstaller/images/image.png data-thumbnail=/posts/flare-on7-crackinstaller/images/image.png><img class=lazyload src=/svg/loading.min.svg data-src=images/image.png data-srcset="/posts/flare-on7-crackinstaller/images/image.png, images/image.png 1.5x, /posts/flare-on7-crackinstaller/images/image.png 2x" data-sizes=auto alt=/posts/flare-on7-crackinstaller/images/image.png></a><p>The challenge description has a clue for the possible usage of COM objects here, so we&rsquo;ll make a mental note of that.</p><p>Simply executing the binary doesn&rsquo;t seem to do much, so we&rsquo;ll fire up a debugger and start looking at the code. IDA Pro identified <code>main</code> for us, so we can simply put a breakpoint at the start of this function and execute the file. Doing that, the process seems to start but immediately exit, without hitting our breakpoint. This tells us that there is probably some interesting code that executes before <code>main</code>. A good place to start looking for this kind of code is the entry point. <code>Ctrl+E</code> in IDA will get us there.</p><div class=highlight><pre class=chroma><code class=language-cpp data-lang=cpp><span class=kr>__int64</span> <span class=nf>start</span><span class=p>()</span>
<span class=p>{</span>
  <span class=n>_security_init_cookie</span><span class=p>();</span>
  <span class=k>return</span> <span class=n>__scrt_common_main_seh</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></div><p>We&rsquo;ll examine <code>__scrt_common_main_seh</code> (from which <code>main</code> is supposed to be invoked). This function seems pretty standard when it comes to C runtime code, so the next place to look for something interesting will be in the function array that is passed to <code>initterm</code>. <code>initterm</code> is an internal CRT function that simply walks a function pointer array and initializes every function there.</p><div class=highlight><pre class=chroma><code class=language-cpp data-lang=cpp><span class=p>.</span><span class=nl>rdata</span><span class=p>:</span><span class=mf>000000014000F</span><span class=mi>2</span><span class=n>B0</span> <span class=p>;</span> <span class=k>const</span> <span class=n>_PVFV</span> <span class=n>First</span>
<span class=p>.</span><span class=nl>rdata</span><span class=p>:</span><span class=mf>000000014000F</span><span class=mi>2</span><span class=n>B0</span> <span class=n>First</span>           <span class=n>dq</span> <span class=mi>0</span>                    <span class=p>;</span> <span class=n>DATA</span> <span class=nl>XREF</span><span class=p>:</span> <span class=n>__scrt_common_main_seh</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=o>+</span><span class=mi>75</span><span class=err>↑</span><span class=n>o</span>
<span class=p>.</span><span class=nl>rdata</span><span class=p>:</span><span class=mf>000000014000F</span><span class=mi>2</span><span class=n>B8</span>                 <span class=n>dq</span> <span class=n>offset</span> <span class=o>?</span><span class=n>pre_cpp_initialization</span><span class=err>@@</span><span class=n>YAXXZ</span> <span class=p>;</span> <span class=n>pre_cpp_initialization</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>.</span><span class=nl>rdata</span><span class=p>:</span><span class=mf>000000014000F</span><span class=mi>2</span><span class=n>C0</span>                 <span class=n>dq</span> <span class=n>offset</span> <span class=n>sub_140001000</span>
<span class=p>.</span><span class=nl>rdata</span><span class=p>:</span><span class=mf>000000014000F</span><span class=mi>2</span><span class=n>C8</span> <span class=p>;</span> <span class=k>const</span> <span class=n>_PVFV</span> <span class=n>Last</span>
<span class=p>.</span><span class=nl>rdata</span><span class=p>:</span><span class=mf>000000014000F</span><span class=mi>2</span><span class=n>C8</span> <span class=n>Last</span>            <span class=n>dq</span> <span class=mi>0</span>
</code></pre></div><p>Looking at this function pointer array, we see two functions - one that IDA identified as <code>pre_cpp_initialization</code> and another one which has no matching signature. We probably have nothing to look for in the function IDA has identified, so let&rsquo;s go to <code>sub_140001000</code> and see what it does. This is just a wrapper for <code>sub_140002530</code> so we&rsquo;ll focus on this one.</p><div class=highlight><pre class=chroma><code class=language-cpp data-lang=cpp><span class=kr>__int64</span> <span class=nf>sub_140002530</span><span class=p>()</span>
<span class=p>{</span>
  <span class=n>v0</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=n>i64</span><span class=p>;</span>
  <span class=n>v1</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=n>hObject</span> <span class=o>=</span> <span class=p>(</span><span class=n>HANDLE</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=n>i64</span><span class=p>;</span>
  <span class=n>v2</span> <span class=o>=</span> <span class=mi>0</span><span class=n>i64</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=n>sub_140001CD8</span><span class=p>()</span> <span class=p>)</span>
  <span class=p>{</span>
    <span class=n>v3</span> <span class=o>=</span> <span class=n>sub_140002370</span><span class=p>(</span><span class=o>&amp;</span><span class=n>unk_1400363B0</span><span class=p>,</span> <span class=mi>8069</span><span class=n>i64</span><span class=p>,</span> <span class=mi>10576</span><span class=n>i64</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span> <span class=n>v3</span> <span class=p>)</span>
    <span class=p>{</span>
      <span class=n>v2</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>sub_140002370</span><span class=p>(</span><span class=o>&amp;</span><span class=n>unk_140034080</span><span class=p>,</span> <span class=mi>8882</span><span class=n>i64</span><span class=p>,</span> <span class=mi>22528</span><span class=n>i64</span><span class=p>);</span>
      <span class=k>if</span> <span class=p>(</span> <span class=n>v2</span> <span class=p>)</span>
      <span class=p>{</span>
        <span class=n>v4</span> <span class=o>=</span> <span class=n>sub_140001C34</span><span class=p>(</span><span class=o>&amp;</span><span class=n>unk_140019988</span><span class=p>,</span> <span class=mi>28</span><span class=n>i64</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>);</span>
        <span class=n>v1</span> <span class=o>=</span> <span class=n>sub_140002ED8</span><span class=p>(</span><span class=n>v4</span><span class=p>,</span> <span class=n>v3</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span> <span class=n>v1</span> <span class=p>)</span>
        <span class=p>{</span>
          <span class=n>v12</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>_QWORD</span> <span class=o>*</span><span class=p>)</span><span class=n>sub_140001C34</span><span class=p>(</span><span class=o>&amp;</span><span class=n>unk_140019900</span><span class=p>,</span> <span class=mi>4</span><span class=n>i64</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>);</span>
          <span class=n>v5</span> <span class=o>=</span> <span class=n>sub_140001C34</span><span class=p>(</span><span class=o>&amp;</span><span class=n>unk_140019988</span><span class=p>,</span> <span class=mi>28</span><span class=n>i64</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>);</span>
          <span class=n>v17</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>_OWORD</span> <span class=o>*</span><span class=p>)</span><span class=n>v5</span><span class=p>;</span>
          <span class=n>v18</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>_OWORD</span> <span class=o>*</span><span class=p>)(</span><span class=n>v5</span> <span class=o>+</span> <span class=mi>16</span><span class=p>);</span>
          <span class=n>v19</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>_OWORD</span> <span class=o>*</span><span class=p>)(</span><span class=n>v5</span> <span class=o>+</span> <span class=mi>32</span><span class=p>);</span>
          <span class=n>v20</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>_QWORD</span> <span class=o>*</span><span class=p>)(</span><span class=n>v5</span> <span class=o>+</span> <span class=mi>48</span><span class=p>);</span>
          <span class=n>v6</span> <span class=o>=</span> <span class=n>sub_140001C34</span><span class=p>(</span><span class=o>&amp;</span><span class=n>unk_1400199C0</span><span class=p>,</span> <span class=mi>15</span><span class=n>i64</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>);</span>
          <span class=n>v13</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>_OWORD</span> <span class=o>*</span><span class=p>)</span><span class=n>v6</span><span class=p>;</span>
          <span class=n>v14</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>_QWORD</span> <span class=o>*</span><span class=p>)(</span><span class=n>v6</span> <span class=o>+</span> <span class=mi>16</span><span class=p>);</span>
          <span class=n>v15</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>_DWORD</span> <span class=o>*</span><span class=p>)(</span><span class=n>v6</span> <span class=o>+</span> <span class=mi>24</span><span class=p>);</span>
          <span class=n>v16</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>_WORD</span> <span class=o>*</span><span class=p>)(</span><span class=n>v6</span> <span class=o>+</span> <span class=mi>28</span><span class=p>);</span>
          <span class=n>v7</span> <span class=o>=</span> <span class=n>sub_140001FB4</span><span class=p>(</span><span class=o>&amp;</span><span class=n>v12</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>v17</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>v13</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>hObject</span><span class=p>);</span>
          <span class=n>v0</span> <span class=o>=</span> <span class=p>(</span><span class=kr>__int64</span><span class=p>)</span><span class=n>hObject</span><span class=p>;</span>
          <span class=n>v1</span> <span class=o>=</span> <span class=n>v7</span><span class=p>;</span>
          <span class=k>if</span> <span class=p>(</span> <span class=n>v7</span> <span class=p>)</span>
          <span class=p>{</span>
            <span class=n>LODWORD</span><span class=p>(</span><span class=n>v12</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
            <span class=o>*</span><span class=p>(</span><span class=n>_QWORD</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>v18</span> <span class=o>=</span> <span class=mi>0</span><span class=n>i64</span><span class=p>;</span>
            <span class=n>v17</span> <span class=o>=</span> <span class=mi>0</span><span class=n>i64</span><span class=p>;</span>
            <span class=n>DWORD2</span><span class=p>(</span><span class=n>v18</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
            <span class=o>*</span><span class=p>(</span><span class=n>_QWORD</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>v13</span> <span class=o>=</span> <span class=mi>0</span><span class=n>i64</span><span class=p>;</span>
            <span class=n>DWORD2</span><span class=p>(</span><span class=n>v13</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
            <span class=n>WORD6</span><span class=p>(</span><span class=n>v13</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
            <span class=n>BYTE14</span><span class=p>(</span><span class=n>v13</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
            <span class=n>v1</span> <span class=o>=</span> <span class=n>sub_140002C44</span><span class=p>(</span><span class=n>hObject</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span> <span class=n>v1</span> <span class=p>)</span>
            <span class=p>{</span>
              <span class=n>v8</span> <span class=o>=</span> <span class=n>sub_140001C34</span><span class=p>(</span><span class=o>&amp;</span><span class=n>unk_140019900</span><span class=p>,</span> <span class=mi>4</span><span class=n>i64</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>);</span>
              <span class=n>v1</span> <span class=o>=</span> <span class=n>sub_140001EB4</span><span class=p>(</span><span class=n>v8</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>;</span>
            <span class=p>}</span>
          <span class=p>}</span>
        <span class=p>}</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=n>v9</span> <span class=o>=</span> <span class=p>(</span><span class=k>const</span> <span class=n>WCHAR</span> <span class=o>*</span><span class=p>)</span><span class=n>sub_140001C34</span><span class=p>(</span><span class=o>&amp;</span><span class=n>unk_140019988</span><span class=p>,</span> <span class=mi>28</span><span class=n>i64</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>);</span>
  <span class=n>v10</span> <span class=o>=</span> <span class=n>CreateFileW</span><span class=p>(</span><span class=n>v9</span><span class=p>,</span> <span class=mh>0x10000000u</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>,</span> <span class=mi>3u</span><span class=p>,</span> <span class=mh>0x4000000u</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span> <span class=n>v10</span> <span class=o>!=</span> <span class=p>(</span><span class=n>HANDLE</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=n>i64</span> <span class=p>)</span>
    <span class=n>CloseHandle</span><span class=p>(</span><span class=n>v10</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span> <span class=n>v0</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span> <span class=p>)</span>
    <span class=n>CloseHandle</span><span class=p>((</span><span class=n>HANDLE</span><span class=p>)</span><span class=n>v0</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span> <span class=n>v2</span> <span class=p>)</span>
  <span class=p>{</span>
    <span class=n>memset</span><span class=p>(</span><span class=n>v2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x5800u</span><span class=n>i64</span><span class=p>);</span>
    <span class=n>free</span><span class=p>(</span><span class=n>v2</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=p>(</span> <span class=o>!</span><span class=n>v1</span> <span class=p>)</span>
    <span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
  <span class=k>return</span> <span class=mi>0</span><span class=n>i64</span><span class=p>;</span>
</code></pre></div><p>Let&rsquo;s rename this to be our <code>init_function</code> so it&rsquo;ll be easy to refer to it. Right before this function returns, we see an if statement the can potentially terminate the process. This aligns with what we saw before, where the process exited even before our breakpoint in <code>main</code>, so looks like we&rsquo;re in the right direction. We&rsquo;ll continue by looking at the first function call here which is to <code>sub_140001CD8</code>.</p><div class=highlight><pre class=chroma><code class=language-cpp data-lang=cpp> <span class=kr>__int64</span> <span class=nf>sub_140001CD8</span><span class=p>()</span>
<span class=p>{</span>
  <span class=n>v0</span> <span class=o>=</span> <span class=p>(</span><span class=k>const</span> <span class=n>CHAR</span> <span class=o>*</span><span class=p>)</span><span class=n>sub_140001B54</span><span class=p>(</span><span class=o>&amp;</span><span class=n>unk_140019A40</span><span class=p>,</span> <span class=mi>13</span><span class=n>i64</span><span class=p>);</span>
  <span class=n>v1</span> <span class=o>=</span> <span class=n>LoadLibraryA</span><span class=p>(</span><span class=n>v0</span><span class=p>);</span>
  <span class=n>v2</span> <span class=o>=</span> <span class=p>(</span><span class=k>const</span> <span class=n>CHAR</span> <span class=o>*</span><span class=p>)</span><span class=n>sub_140001B54</span><span class=p>(</span><span class=o>&amp;</span><span class=n>unk_1400199D0</span><span class=p>,</span> <span class=mi>13</span><span class=n>i64</span><span class=p>);</span>
  <span class=n>v3</span> <span class=o>=</span> <span class=n>LoadLibraryA</span><span class=p>(</span><span class=n>v2</span><span class=p>);</span>
  <span class=n>v4</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=n>v5</span> <span class=o>=</span> <span class=n>v3</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span> <span class=n>v1</span> <span class=p>)</span>
  <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span> <span class=n>v3</span> <span class=p>)</span>
    <span class=p>{</span>
      <span class=n>v6</span> <span class=o>=</span> <span class=p>(</span><span class=k>const</span> <span class=n>CHAR</span> <span class=o>*</span><span class=p>)</span><span class=n>sub_140001B54</span><span class=p>(</span><span class=o>&amp;</span><span class=n>unk_140019918</span><span class=p>,</span> <span class=mi>15</span><span class=n>i64</span><span class=p>);</span>
      <span class=n>qword_1400395F8</span> <span class=o>=</span> <span class=p>(</span><span class=kr>__int64</span><span class=p>)</span><span class=n>GetProcAddress</span><span class=p>(</span><span class=n>v1</span><span class=p>,</span> <span class=n>v6</span><span class=p>);</span>
      <span class=k>if</span> <span class=p>(</span> <span class=n>qword_1400395F8</span> <span class=p>)</span>
      <span class=p>{</span>
        <span class=n>v7</span> <span class=o>=</span> <span class=p>(</span><span class=k>const</span> <span class=n>CHAR</span> <span class=o>*</span><span class=p>)</span><span class=n>sub_140001B54</span><span class=p>(</span><span class=o>&amp;</span><span class=n>unk_140019A70</span><span class=p>,</span> <span class=mi>13</span><span class=n>i64</span><span class=p>);</span>
        <span class=n>qword_1400395C8</span> <span class=o>=</span> <span class=p>(</span><span class=kr>__int64</span><span class=p>)</span><span class=n>GetProcAddress</span><span class=p>(</span><span class=n>v1</span><span class=p>,</span> <span class=n>v7</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span> <span class=n>qword_1400395C8</span> <span class=p>)</span>
        <span class=p>{</span>
          <span class=n>v8</span> <span class=o>=</span> <span class=p>(</span><span class=k>const</span> <span class=n>CHAR</span> <span class=o>*</span><span class=p>)</span><span class=n>sub_140001B54</span><span class=p>(</span><span class=o>&amp;</span><span class=n>unk_140019928</span><span class=p>,</span> <span class=mi>19</span><span class=n>i64</span><span class=p>);</span>
          <span class=n>qword_1400395F0</span> <span class=o>=</span> <span class=p>(</span><span class=kr>__int64</span><span class=p>)</span><span class=n>GetProcAddress</span><span class=p>(</span><span class=n>v1</span><span class=p>,</span> <span class=n>v8</span><span class=p>);</span>
          <span class=k>if</span> <span class=p>(</span> <span class=n>qword_1400395F0</span> <span class=p>)</span>
          <span class=p>{</span>
            <span class=n>v9</span> <span class=o>=</span> <span class=p>(</span><span class=k>const</span> <span class=n>CHAR</span> <span class=o>*</span><span class=p>)</span><span class=n>sub_140001B54</span><span class=p>(</span><span class=o>&amp;</span><span class=n>unk_140019A50</span><span class=p>,</span> <span class=mi>14</span><span class=n>i64</span><span class=p>);</span>
            <span class=n>qword_1400395D8</span> <span class=o>=</span> <span class=p>(</span><span class=kr>__int64</span><span class=p>)</span><span class=n>GetProcAddress</span><span class=p>(</span><span class=n>v1</span><span class=p>,</span> <span class=n>v9</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span> <span class=n>qword_1400395D8</span> <span class=p>)</span>
            <span class=p>{</span>
              <span class=n>v10</span> <span class=o>=</span> <span class=p>(</span><span class=k>const</span> <span class=n>CHAR</span> <span class=o>*</span><span class=p>)</span><span class=n>sub_140001B54</span><span class=p>(</span><span class=o>&amp;</span><span class=n>unk_1400199F0</span><span class=p>,</span> <span class=mi>15</span><span class=n>i64</span><span class=p>);</span>
              <span class=n>qword_1400395E0</span> <span class=o>=</span> <span class=p>(</span><span class=kr>__int64</span><span class=p>)</span><span class=n>GetProcAddress</span><span class=p>(</span><span class=n>v1</span><span class=p>,</span> <span class=n>v10</span><span class=p>);</span>
              <span class=k>if</span> <span class=p>(</span> <span class=n>qword_1400395E0</span> <span class=p>)</span>
              <span class=p>{</span>
                <span class=n>v11</span> <span class=o>=</span> <span class=p>(</span><span class=k>const</span> <span class=n>CHAR</span> <span class=o>*</span><span class=p>)</span><span class=n>sub_140001B54</span><span class=p>(</span><span class=o>&amp;</span><span class=n>unk_140019940</span><span class=p>,</span> <span class=mi>14</span><span class=n>i64</span><span class=p>);</span>
                <span class=n>qword_1400395D0</span> <span class=o>=</span> <span class=p>(</span><span class=kr>__int64</span><span class=p>)</span><span class=n>GetProcAddress</span><span class=p>(</span><span class=n>v1</span><span class=p>,</span> <span class=n>v11</span><span class=p>);</span>
                <span class=k>if</span> <span class=p>(</span> <span class=n>qword_1400395D0</span> <span class=p>)</span>
                <span class=p>{</span>
                  <span class=n>v12</span> <span class=o>=</span> <span class=p>(</span><span class=k>const</span> <span class=n>CHAR</span> <span class=o>*</span><span class=p>)</span><span class=n>sub_140001B54</span><span class=p>(</span><span class=o>&amp;</span><span class=n>unk_140019908</span><span class=p>,</span> <span class=mi>15</span><span class=n>i64</span><span class=p>);</span>
                  <span class=n>qword_1400395E8</span> <span class=o>=</span> <span class=p>(</span><span class=kr>__int64</span><span class=p>)</span><span class=n>GetProcAddress</span><span class=p>(</span><span class=n>v1</span><span class=p>,</span> <span class=n>v12</span><span class=p>);</span>
                  <span class=k>if</span> <span class=p>(</span> <span class=n>qword_1400395E8</span> <span class=p>)</span>
                  <span class=p>{</span>
                    <span class=n>v13</span> <span class=o>=</span> <span class=p>(</span><span class=k>const</span> <span class=n>CHAR</span> <span class=o>*</span><span class=p>)</span><span class=n>sub_140001B54</span><span class=p>(</span><span class=o>&amp;</span><span class=n>unk_1400199E0</span><span class=p>,</span> <span class=mi>12</span><span class=n>i64</span><span class=p>);</span>
                    <span class=n>qword_140039600</span> <span class=o>=</span> <span class=p>(</span><span class=kr>__int64</span><span class=p>)</span><span class=n>GetProcAddress</span><span class=p>(</span><span class=n>v5</span><span class=p>,</span> <span class=n>v13</span><span class=p>);</span>
                    <span class=k>if</span> <span class=p>(</span> <span class=n>qword_140039600</span> <span class=p>)</span>
                      <span class=n>v4</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
                  <span class=p>}</span>
                <span class=p>}</span>
              <span class=p>}</span>
            <span class=p>}</span>
          <span class=p>}</span>
        <span class=p>}</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>v4</span><span class=p>;</span>
</code></pre></div><p>This seems like a rather simple function that loads a couple of DLLs using <code>LoadLibraryA</code> and then locates a few functions from those DLLs using <code>GetProcAddress</code>. As you see, before every function call to load a library or to locate a function, we have a call to <code>sub_140001B54</code>, passing a location and a number to it. Experienced reverse engineers may already guess that this is a string decryption routine, that accepts the encoded string, and its size. Since we only have a handful of functions being resolved here, you can either execute this and then examine dynamically which functions have been resolved, or you can write a quick script to perform the decoding of the function names for you. If you&rsquo;ve chosen to decode the strings yourself, you&rsquo;ll need to look at the decoding function.</p><div class=highlight><pre class=chroma><code class=language-cpp data-lang=cpp><span class=kt>char</span> <span class=o>*</span><span class=kr>__fastcall</span> <span class=nf>sub_140001B54</span><span class=p>(</span><span class=kr>__int64</span> <span class=n>a1</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>a2</span><span class=p>,</span> <span class=kt>int</span> <span class=n>a3</span><span class=p>)</span>
<span class=p>{</span>
  <span class=n>dword_1400395B0</span> <span class=o>+=</span> <span class=n>a3</span><span class=p>;</span>
  <span class=n>v3</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span> <span class=n>a2</span> <span class=p>)</span>
  <span class=p>{</span>
    <span class=n>v4</span> <span class=o>=</span> <span class=n>Source</span><span class=p>;</span>
    <span class=n>v5</span> <span class=o>=</span> <span class=n>a2</span><span class=p>;</span>
    <span class=k>do</span>
    <span class=p>{</span>
      <span class=o>*</span><span class=n>v4</span> <span class=o>=</span> <span class=n>v4</span><span class=p>[</span><span class=n>a1</span> <span class=o>-</span> <span class=p>(</span><span class=n>_QWORD</span><span class=p>)</span><span class=n>Source</span><span class=p>]</span> <span class=o>^</span> <span class=n>aGIt</span><span class=p>[</span><span class=n>v3</span><span class=p>];</span>
      <span class=o>++</span><span class=n>v4</span><span class=p>;</span>
      <span class=n>v3</span> <span class=o>=</span> <span class=p>(</span><span class=n>v3</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>%</span> <span class=mi>7</span><span class=p>;</span>
      <span class=o>--</span><span class=n>v5</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>while</span> <span class=p>(</span> <span class=n>v5</span> <span class=p>);</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>Source</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>This looks like a simple XOR decryption routine, that uses <code>'&lt;g~{&lt;it'</code> as the key. Not too bad. We can decode and rename the encrypted strings as we go. We&rsquo;ll rename the function names and the resolved function pointers and continue our analysis. After decoding and renaming the pointers, we get this.</p><div class=highlight><pre class=chroma><code class=language-cpp data-lang=cpp><span class=kr>__int64</span> <span class=kr>__stdcall</span> <span class=nf>ResolvAPIs</span><span class=p>()</span>
<span class=p>{</span>
  <span class=n>v0</span> <span class=o>=</span> <span class=n>decode_string</span><span class=p>((</span><span class=kr>__int64</span><span class=p>)</span><span class=o>&amp;</span><span class=n>enc_advapi</span><span class=p>,</span> <span class=mh>0xDu</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
  <span class=n>v1</span> <span class=o>=</span> <span class=n>LoadLibraryA</span><span class=p>(</span><span class=n>v0</span><span class=p>);</span>
  <span class=n>v2</span> <span class=o>=</span> <span class=n>decode_string</span><span class=p>((</span><span class=kr>__int64</span><span class=p>)</span><span class=o>&amp;</span><span class=n>en_kernel32_dll</span><span class=p>,</span> <span class=mh>0xDu</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
  <span class=n>v3</span> <span class=o>=</span> <span class=n>LoadLibraryA</span><span class=p>(</span><span class=n>v2</span><span class=p>);</span>
  <span class=n>v4</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=n>v5</span> <span class=o>=</span> <span class=n>v3</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span> <span class=n>v1</span> <span class=p>)</span>
  <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span> <span class=n>v3</span> <span class=p>)</span>
    <span class=p>{</span>
      <span class=n>v6</span> <span class=o>=</span> <span class=n>decode_string</span><span class=p>((</span><span class=kr>__int64</span><span class=p>)</span><span class=o>&amp;</span><span class=n>enc_CreateServiceW</span><span class=p>,</span> <span class=mh>0xFu</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
      <span class=n>CreateServiceW</span> <span class=o>=</span> <span class=p>(</span><span class=kr>__int64</span> <span class=p>(</span><span class=kr>__fastcall</span> <span class=o>*</span><span class=p>)(</span><span class=n>_QWORD</span><span class=p>,</span> <span class=n>_QWORD</span><span class=p>,</span> <span class=n>_QWORD</span><span class=p>,</span> <span class=n>_QWORD</span><span class=p>,</span> <span class=n>_DWORD</span><span class=p>,</span> <span class=n>_DWORD</span><span class=p>,</span> <span class=n>_DWORD</span><span class=p>,</span> <span class=n>_QWORD</span><span class=p>,</span> <span class=n>_QWORD</span><span class=p>,</span> <span class=n>_QWORD</span><span class=p>,</span> <span class=n>_QWORD</span><span class=p>,</span> <span class=n>_QWORD</span><span class=p>,</span> <span class=n>_QWORD</span><span class=p>))</span><span class=n>GetProcAddress</span><span class=p>(</span><span class=n>v1</span><span class=p>,</span> <span class=n>v6</span><span class=p>);</span>
      <span class=k>if</span> <span class=p>(</span> <span class=n>CreateServiceW</span> <span class=p>)</span>
      <span class=p>{</span>
        <span class=n>v7</span> <span class=o>=</span> <span class=n>decode_string</span><span class=p>((</span><span class=kr>__int64</span><span class=p>)</span><span class=o>&amp;</span><span class=n>enc_OpenServiceW</span><span class=p>,</span> <span class=mh>0xDu</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
        <span class=n>OpenServiceW</span> <span class=o>=</span> <span class=p>(</span><span class=kr>__int64</span> <span class=p>(</span><span class=kr>__fastcall</span> <span class=o>*</span><span class=p>)(</span><span class=n>_QWORD</span><span class=p>,</span> <span class=n>_QWORD</span><span class=p>,</span> <span class=n>_QWORD</span><span class=p>))</span><span class=n>GetProcAddress</span><span class=p>(</span><span class=n>v1</span><span class=p>,</span> <span class=n>v7</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span> <span class=n>OpenServiceW</span> <span class=p>)</span>
        <span class=p>{</span>
          <span class=n>v8</span> <span class=o>=</span> <span class=n>decode_string</span><span class=p>((</span><span class=kr>__int64</span><span class=p>)</span><span class=o>&amp;</span><span class=n>enc_CloseServiceHandle</span><span class=p>,</span> <span class=mh>0x13u</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
          <span class=n>CloseServiceHandle</span> <span class=o>=</span> <span class=p>(</span><span class=kr>__int64</span> <span class=p>(</span><span class=kr>__fastcall</span> <span class=o>*</span><span class=p>)(</span><span class=n>_QWORD</span><span class=p>))</span><span class=n>GetProcAddress</span><span class=p>(</span><span class=n>v1</span><span class=p>,</span> <span class=n>v8</span><span class=p>);</span>
          <span class=k>if</span> <span class=p>(</span> <span class=n>CloseServiceHandle</span> <span class=p>)</span>
          <span class=p>{</span>
            <span class=n>v9</span> <span class=o>=</span> <span class=n>decode_string</span><span class=p>((</span><span class=kr>__int64</span><span class=p>)</span><span class=o>&amp;</span><span class=n>enc_StartServiceW</span><span class=p>,</span> <span class=mh>0xEu</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
            <span class=n>StartServiceW</span> <span class=o>=</span> <span class=p>(</span><span class=kr>__int64</span> <span class=p>(</span><span class=kr>__fastcall</span> <span class=o>*</span><span class=p>)(</span><span class=n>_QWORD</span><span class=p>,</span> <span class=n>_QWORD</span><span class=p>,</span> <span class=n>_QWORD</span><span class=p>))</span><span class=n>GetProcAddress</span><span class=p>(</span><span class=n>v1</span><span class=p>,</span> <span class=n>v9</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span> <span class=n>StartServiceW</span> <span class=p>)</span>
            <span class=p>{</span>
              <span class=n>v10</span> <span class=o>=</span> <span class=n>decode_string</span><span class=p>((</span><span class=kr>__int64</span><span class=p>)</span><span class=o>&amp;</span><span class=n>enc_ControlService</span><span class=p>,</span> <span class=mh>0xFu</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
              <span class=n>ControlService</span> <span class=o>=</span> <span class=p>(</span><span class=kr>__int64</span> <span class=p>(</span><span class=kr>__fastcall</span> <span class=o>*</span><span class=p>)(</span><span class=n>_QWORD</span><span class=p>,</span> <span class=n>_QWORD</span><span class=p>,</span> <span class=n>_QWORD</span><span class=p>))</span><span class=n>GetProcAddress</span><span class=p>(</span><span class=n>v1</span><span class=p>,</span> <span class=n>v10</span><span class=p>);</span>
              <span class=k>if</span> <span class=p>(</span> <span class=n>ControlService</span> <span class=p>)</span>
              <span class=p>{</span>
                <span class=n>v11</span> <span class=o>=</span> <span class=n>decode_string</span><span class=p>((</span><span class=kr>__int64</span><span class=p>)</span><span class=o>&amp;</span><span class=n>enc_DeleteService</span><span class=p>,</span> <span class=mh>0xEu</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
                <span class=n>DeleteService</span> <span class=o>=</span> <span class=p>(</span><span class=kr>__int64</span> <span class=p>(</span><span class=kr>__fastcall</span> <span class=o>*</span><span class=p>)(</span><span class=n>_QWORD</span><span class=p>))</span><span class=n>GetProcAddress</span><span class=p>(</span><span class=n>v1</span><span class=p>,</span> <span class=n>v11</span><span class=p>);</span>
                <span class=k>if</span> <span class=p>(</span> <span class=n>DeleteService</span> <span class=p>)</span>
                <span class=p>{</span>
                  <span class=n>v12</span> <span class=o>=</span> <span class=n>decode_string</span><span class=p>((</span><span class=kr>__int64</span><span class=p>)</span><span class=o>&amp;</span><span class=n>enc_OpenSCManagerW</span><span class=p>,</span> <span class=mh>0xFu</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
                  <span class=n>OpenSCManagerW</span> <span class=o>=</span> <span class=p>(</span><span class=kr>__int64</span> <span class=p>(</span><span class=kr>__fastcall</span> <span class=o>*</span><span class=p>)(</span><span class=n>_QWORD</span><span class=p>,</span> <span class=n>_QWORD</span><span class=p>,</span> <span class=n>_QWORD</span><span class=p>))</span><span class=n>GetProcAddress</span><span class=p>(</span><span class=n>v1</span><span class=p>,</span> <span class=n>v12</span><span class=p>);</span>
                  <span class=k>if</span> <span class=p>(</span> <span class=n>OpenSCManagerW</span> <span class=p>)</span>
                  <span class=p>{</span>
                    <span class=n>v13</span> <span class=o>=</span> <span class=n>decode_string</span><span class=p>((</span><span class=kr>__int64</span><span class=p>)</span><span class=o>&amp;</span><span class=n>enc_CreateFileW</span><span class=p>,</span> <span class=mh>0xCu</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
                    <span class=n>CreateFileW_0</span> <span class=o>=</span> <span class=p>(</span><span class=kr>__int64</span> <span class=p>(</span><span class=kr>__fastcall</span> <span class=o>*</span><span class=p>)(</span><span class=n>_QWORD</span><span class=p>,</span> <span class=n>_QWORD</span><span class=p>,</span> <span class=n>_QWORD</span><span class=p>,</span> <span class=n>_QWORD</span><span class=p>,</span> <span class=n>_DWORD</span><span class=p>,</span> <span class=n>_DWORD</span><span class=p>,</span> <span class=n>_QWORD</span><span class=p>))</span><span class=n>GetProcAddress</span><span class=p>(</span><span class=n>v5</span><span class=p>,</span> <span class=n>v13</span><span class=p>);</span>
                    <span class=k>if</span> <span class=p>(</span> <span class=n>CreateFileW_0</span> <span class=p>)</span>
                      <span class=n>v4</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
                  <span class=p>}</span>
                <span class=p>}</span>
              <span class=p>}</span>
            <span class=p>}</span>
          <span class=p>}</span>
        <span class=p>}</span>
</code></pre></div><p>Now that we have resolved the API functions the binary is going to use, we can continue analyzing our <code>init_function</code>. In it, we see another function (<code>sub_140002370</code>) that calls <code>decode_string</code>, but this time it converts it to a Unicode string before it returns it, let&rsquo;s rename it <code>decode_string_unicode</code>. And then, we can also rename the encoded strings that are passed to this function as well, as we did before. Now we can continue to see what functions our <code>initi_functions</code> invokes:</p><ol><li><code>sub_140002370</code> - decodes and returns an executable file (PE format)</li><li><code>sub_140002ED8</code> - seem to be writing the data from the second argument to a file, it writes the data it got from the previous function to <code>C:\Windows\System32\cfs.dll</code>.</li><li><code>sub_140001FB4</code> - accepts a service name and a binary path, then creates a service and starts it. At this point, we understand that the <code>cfs.dll</code> the binary dumps is actually a driver. After running the service the function stores a handle to the <code>\\.\Htsysm72FB</code> device in the fourth argument. Some of you may already know what this device is, but even if you don&rsquo;t a quick search will tell you immediately. This is the famous vulnerable Capcom driver, which basically allows an unprivileged user to execute code in the kernel.</li></ol><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon fas fa-lightbulb fa-fw"></i>Tip<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content><p>The sole purpose of this Capcom driver here is to accept an IOCTL, then disable SMEP (prevents the kernel to execute user code), execute code from the user and reenable SMEP again. If you&rsquo;d like to read a full analysis of this vulnerable driver, we recommend reading the following:</p><ul><li><a href=https://github.com/notscimmy/libcapcom target=_blank rel="noopener noreffer">https://github.com/notscimmy/libcapcom</a></li><li><a href=https://www.fuzzysecurity.com/tutorials/28.html target=_blank rel="noopener noreffer">https://www.fuzzysecurity.com/tutorials/28.html</a></li></ul></div></div></div><ol start=4><li><code>sub_140002C44</code> - accepts the handle to the device and a pointer to the second PE file decoded by <code>sub_140002370</code>. It then locates the export <code>DriverBootstrap</code> from our driver and ultimately calls <code>DeviceIOControl</code>, with IOCTL code <code>0xAA013044</code> and a buffer pointing to code that contains the address of <code>DriverBootstrap</code>.</li></ol><p>Since we already know this driver is Capcom, we know this IOCTL will make the driver disable SMEP, and then jumping to the user-supplied code in the input buffer of the <code>DeviceIoControl</code>. The easiest way to continue is to debug this and have a look at the code the kernel will be executing. But before we start <em>WinDbg</em>, we need to figure out where we&rsquo;d like to break. A quick way is to locate where the dumped <code>cfs.dll</code> driver handles our IOCTL. We open up IDA and hit <code>Ctrl+I</code> to search an immediate value, which brings us to the dispatch function that handles <code>IRP_MJ_DEVICE_CONTROL</code> requests - <code>sub_10590</code>. Here we see that this IOCTL will ultimately bring to the invocation of <code>sub_10524</code> which accepts a pointer, disables SMEP, and jumps to it. This is where we&rsquo;d like to break to we take the <code>call</code> address and subtract is from the module base to get its offset in the driver.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>Python</span><span class=o>&gt;</span><span class=mh>0x00010573</span> <span class=o>-</span> <span class=n>idaapi</span><span class=o>.</span><span class=n>get_imagebase</span><span class=p>()</span>
<span class=mh>0x573</span>
</code></pre></div><p>Next, we can connect a kernel debugger to our VM, and set an unresolved breakpoint on our desired address.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kd&gt; bu cfs+573
*** Bp expression <span class=s1>&#39;cfs+573&#39;</span> contains symbols not qualified with module name.
</code></pre></div><p>Now can hit <code>g</code> and execute <code>crackinstaller.exe</code>.</p><pre><code class=language-markup data-lang=markup>kd&gt; g
Breakpoint 0 hit
cfs+0x573:
fffff806`6c270573 ff542428        call    qword ptr [rsp+28h]
kd&gt; t
00000201`c7d00008 fb              sti
kd&gt; u
00000201`c7d00008 fb              sti
00000201`c7d00009 48bae0dac1c701020000 mov rdx,201C7C1DAE0h
00000201`c7d00013 41b800580000    mov     r8d,5800h
00000201`c7d00019 41b970310000    mov     r9d,3170h
00000201`c7d0001f ff2500000000    jmp     qword ptr [00000201`c7d00025]
</code></pre><p>Now we&rsquo;re executing the code from the user. Let&rsquo;s try to run until the first dynamic function call to see what it is.</p><div class=highlight><pre class=chroma><code class=language-cpp data-lang=cpp><span class=mf>00007ff</span><span class=mi>7</span><span class=err>`</span><span class=mi>6</span><span class=n>d482c26</span> <span class=n>ff542448</span>        <span class=n>call</span>    <span class=n>qword</span> <span class=n>ptr</span> <span class=p>[</span><span class=n>rsp</span><span class=o>+</span><span class=mi>48</span><span class=n>h</span><span class=p>]</span> <span class=nl>ss</span><span class=p>:</span><span class=mo>001</span><span class=mi>8</span><span class=o>:</span><span class=n>ffffd201</span><span class=err>`</span><span class=mo>06</span><span class=n>aca678</span><span class=o>=</span><span class=p>{</span><span class=n>nt</span><span class=o>!**</span><span class=n>PsCreateSystemThread</span><span class=o>**</span> <span class=p>(</span><span class=n>fffff803</span><span class=err>`</span><span class=mf>5409f</span><span class=mi>5</span><span class=n>a0</span><span class=p>)}</span>
</code></pre></div><p>This code creates a new system thread, which starts at the routine pointed to by the 6th argument.</p><pre><code class=language-markup data-lang=markup>kd&gt; dq rsp+5*8 l1
fffffc81`ca74f658  ffffa589`fc006170 
kd&gt; bp ffffa589`fc006170 
kd&gt; u ffffa589`fc006170 
ffffa589`fc006170 48894c2408      mov     qword ptr [rsp+8],rcx
ffffa589`fc006175 56              push    rsi
ffffa589`fc006176 57              push    rdi
ffffa589`fc006177 4881ec88000000  sub     rsp,88h
ffffa589`fc00617e 488d442448      lea     rax,[rsp+48h]
ffffa589`fc006183 488bf8          mov     rdi,rax
ffffa589`fc006186 33c0            xor     eax,eax
ffffa589`fc006188 b930000000      mov     ecx,30h
</code></pre><p>You may recognize this function as <code>DriverBootstrap</code>! We&rsquo;ll set a breakpoint on it and <code>g</code>.</p><p>When you get to code you recognize in <em>WinDbg</em> (<code>DriverBootstrap</code>) it&rsquo;s a good idea to rebase the driver in IDA so that addresses match (<em>Edit→Segments→Rebse program&mldr;</em></p><p><code>DriverBootstrap</code> main purpose is to call the undocumented function <code>[IoCreateDriver](http://www.codewarrior.cn/ntdoc/win2k/io/IoCreateDriver.htm)</code> with our driver&rsquo;s <code>DriverEntry</code> as the <em>InitializationFunction.</em> Thus, our analysis will continue to this function.</p><div class=highlight><pre class=chroma><code class=language-cpp data-lang=cpp><span class=n>NTSTATUS</span> <span class=kr>__stdcall</span> <span class=nf>DriverEntry</span><span class=p>(</span><span class=n>PDRIVER_OBJECT</span> <span class=n>DriverObject</span><span class=p>,</span> <span class=n>PUNICODE_STRING</span> <span class=n>RegistryPath</span><span class=p>)</span>
<span class=p>{</span>
  <span class=n>_security_init_cookie</span><span class=p>();</span>
  <span class=k>return</span> <span class=n>driver_main_function</span><span class=p>(</span><span class=n>DriverObject</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>Since it only passes the driver object, we&rsquo;ll continue to the next function.</p><div class=highlight><pre class=chroma><code class=language-cpp data-lang=cpp><span class=kr>__int64</span> <span class=kr>__fastcall</span> <span class=nf>driver_main_function</span><span class=p>(</span><span class=k>struct</span> <span class=nc>_DRIVER_OBJECT</span> <span class=o>*</span><span class=n>a1</span><span class=p>)</span>
<span class=p>{</span>
  <span class=n>DeviceObject</span> <span class=o>=</span> <span class=mi>0</span><span class=n>i64</span><span class=p>;</span>
  <span class=n>memset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>Altitude</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>Altitude</span><span class=p>));</span>
  <span class=n>memset</span><span class=p>(</span><span class=n>v6</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x100u</span><span class=n>i64</span><span class=p>);</span>
  <span class=n>Altitude</span><span class=p>.</span><span class=n>Buffer</span> <span class=o>=</span> <span class=p>(</span><span class=n>PWSTR</span><span class=p>)</span><span class=n>v6</span><span class=p>;</span>
  <span class=n>callCallXORDecrypt</span><span class=p>((</span><span class=kr>__int64</span><span class=p>)</span><span class=o>&amp;</span><span class=n>enc_360000</span><span class=p>,</span> <span class=mi>7u</span><span class=p>,</span> <span class=p>(</span><span class=kr>__int64</span><span class=p>)</span><span class=o>&amp;</span><span class=n>Altitude</span><span class=p>);</span>
  <span class=n>a1</span><span class=o>-&gt;</span><span class=n>DriverUnload</span> <span class=o>=</span> <span class=p>(</span><span class=n>PDRIVER_UNLOAD</span><span class=p>)</span><span class=n>driver_unload</span><span class=p>;</span>
  <span class=n>v2</span> <span class=o>=</span> <span class=n>IoCreateDevice</span><span class=p>(</span><span class=n>a1</span><span class=p>,</span> <span class=mh>0x60u</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>,</span> <span class=mh>0x22u</span><span class=p>,</span> <span class=mh>0x100u</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>DeviceObject</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span> <span class=n>v2</span> <span class=o>&gt;=</span> <span class=mi>0</span> <span class=p>)</span>
  <span class=p>{</span>
    <span class=n>v3</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>DeviceObject</span><span class=o>-&gt;</span><span class=n>DeviceExtension</span><span class=p>;</span>
    <span class=n>ExInitializeFastMutex</span><span class=p>((</span><span class=n>PFAST_MUTEX</span><span class=p>)(</span><span class=n>v3</span> <span class=o>+</span> <span class=mi>8</span><span class=p>));</span>
    <span class=n>KeInitializeEvent</span><span class=p>((</span><span class=n>PRKEVENT</span><span class=p>)(</span><span class=n>v3</span> <span class=o>+</span> <span class=mi>64</span><span class=p>),</span> <span class=n>NotificationEvent</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
    <span class=o>*</span><span class=p>(</span><span class=n>_DWORD</span> <span class=o>*</span><span class=p>)</span><span class=n>v3</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=n>v3</span><span class=p>[</span><span class=mi>88</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=n>v2</span> <span class=o>=</span> <span class=n>CmRegisterCallbackEx</span><span class=p>((</span><span class=n>PEX_CALLBACK_FUNCTION</span><span class=p>)</span><span class=n>CallbackFunction</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>Altitude</span><span class=p>,</span> <span class=n>a1</span><span class=p>,</span> <span class=n>a1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>Cookie</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=p>(</span> <span class=n>v2</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>DeviceObject</span> <span class=p>)</span>
    <span class=n>IoDeleteDevice</span><span class=p>(</span><span class=n>DeviceObject</span><span class=p>);</span>
  <span class=k>return</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=n>v2</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>Most of the code is pretty standard for a Windows driver, stuff like creating a device, populating a driver unload function. In addition to that, we also have a call to <a href=https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-cmregistercallbackex target=_blank rel="noopener noreffer">CmRegisterCallbackEx</a> which registers a callback function for the configuration manager (registry). The most important parameter for us here is the first one, which is a pointer to the <a href=https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-cmregistercallbackex target=_blank rel="noopener noreffer">RegistryCallback</a> routine to register. Now our driver has a function that ntoskrnl will invoke that is able to monitor, block, or modify registry operations. Let&rsquo;s dive into it and see what is its purpose. A good place to start is to understand what this callback function should get as its arguments. From the <a href=https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-cmregistercallbackex target=_blank rel="noopener noreffer">RegistryCallback</a> documentation, we can see that the second and third parameters that it accepts are the type of registry operation (REG_NOTIFY_CLASS) and an optional pointer to a structure, containing information specific to the type of operation. These will be passed by the OS kernel, based on the type of operation that the function gets a callback for. The first argument, however, is called <em>CallbackContext</em>, and it&rsquo;s whatever the driver passed as the <em>Context</em> parameter when it registered this callback function. In our case, it was <code>a1</code> which is simply the driver object.</p><div class=highlight><pre class=chroma><code class=language-cpp data-lang=cpp><span class=n>v2</span> <span class=o>=</span> <span class=n>CmRegisterCallbackEx</span><span class=p>((</span><span class=n>PEX_CALLBACK_FUNCTION</span><span class=p>)</span><span class=n>CallbackFunction</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>Altitude</span><span class=p>,</span> <span class=n>a1</span><span class=p>,</span> <span class=n>a1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>Cookie</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>);</span>
</code></pre></div><p>We&rsquo;ll set the appropriate type in IDA for easier analysis, and start examining the callback function itself. For analyzing <code>CallbackFunction</code> we will set the first parameter&rsquo;s type to <code>_DRIVER_OBJECT</code> and the second parameter&rsquo;s type to <code>_REG_CREATE_KEY_INFORMATION</code>.</p><p>First this function will check if the notification is of type <code>RegNtPreCreateKeyEx</code></p><div class=highlight><pre class=chroma><code class=language-cpp data-lang=cpp><span class=k>if</span> <span class=p>(</span> <span class=n>NotifyClass</span> <span class=o>&amp;&amp;</span> <span class=n>OperationInformation</span> <span class=o>&amp;&amp;</span> <span class=n>CallbackContext</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>_DWORD</span><span class=p>)</span><span class=n>NotifyClass</span> <span class=o>==</span> <span class=n>RegNtPreCreateKeyEx</span> <span class=p>)</span>
</code></pre></div><p>Then it will check if the registry path of this operation it got a callback from is a relative path, and if it is, it will construct the complete path. After that, this function will decrypt a buffer using <code>sub_140004DC0</code>, and use <code>wcsstr</code> to check if the decrypted buffer is contained in the full path of the current registry operation. Simply debugging until this <code>wcsstr</code> call, we see that the path is checked for the presence of <code>{CEEACC6E-CCB2-4C4F-BCF6-D2176037A9A7}\Config</code>.</p><div class=highlight><pre class=chroma><code class=language-cpp data-lang=cpp><span class=n>kd</span><span class=o>&gt;</span> <span class=n>du</span> <span class=n>rdx</span>
<span class=n>fffffc81</span><span class=err>`</span><span class=n>c8eb6ff0</span>  <span class=s>&#34;{CEEACC6E-CCB2-4C4F-BCF6-D217603&#34;</span>
<span class=n>fffffc81</span><span class=err>`</span><span class=n>c8eb7030</span>  <span class=s>&#34;7A9A7}\Config&#34;</span>
</code></pre></div><p>If this registry operation is the one that this comparison is looking for, it will decrypt another buffer, construct an <code>_OBJECT_ATTRIBUTES</code> structure, and then call <code>ZwCreateKey</code>. There are two parameters that are interesting for us here, and we&rsquo;ll debug the function until this call in order to see what&rsquo;s being passed to it.</p><ul><li><p>3rd argument - this is the target key <code>_OBJECT_ATTRIBUTES</code>. It contains the path of the key, which set to be the full path of the key being accessed in the current registry operation to which we get the callback. So, it should be <code>\HKEY_CLASSES_ROOT\CLSID\{CEEACC6E-CCB2-4C4F-BCF6-D2176037A9A7}\Config</code></p><div class=highlight><pre class=chroma><code class=language-cpp data-lang=cpp><span class=n>kd</span><span class=o>&gt;</span> <span class=n>r</span> <span class=n>r8</span>
<span class=n>r8</span><span class=o>=</span><span class=n>fffffc81c81e71a8</span>
<span class=n>kd</span><span class=o>&gt;</span> <span class=n>dt</span> <span class=n>nt</span><span class=o>!</span><span class=n>_OBJECT_ATTRIBUTES</span> <span class=n>fffffc81c81e71a8</span>
   <span class=o>+</span><span class=mh>0x000</span> <span class=nl>Length</span>           <span class=p>:</span> <span class=mh>0x30</span>
   <span class=o>+</span><span class=mh>0x008</span> <span class=nl>RootDirectory</span>    <span class=p>:</span> <span class=p>(</span><span class=n>null</span><span class=p>)</span> 
   <span class=o>+</span><span class=mh>0x010</span> <span class=nl>ObjectName</span>       <span class=p>:</span> <span class=mh>0xffffbd00</span><span class=err>`</span><span class=mf>9366e2</span><span class=n>e0</span> <span class=n>_UNICODE_STRING</span> <span class=s>&#34;\REGISTRY\MACHINE\SOFTWARE\Classes\CLSID\{CEEACC6E-CCB2-4C4F-BCF6-D2176037A9A7}\Config&#34;</span>
   <span class=o>+</span><span class=mh>0x018</span> <span class=nl>Attributes</span>       <span class=p>:</span> <span class=mh>0x240</span>
   <span class=o>+</span><span class=mh>0x020</span> <span class=nl>SecurityDescriptor</span> <span class=p>:</span> <span class=p>(</span><span class=n>null</span><span class=p>)</span> 
   <span class=o>+</span><span class=mh>0x028</span> <span class=nl>SecurityQualityOfService</span> <span class=p>:</span> <span class=p>(</span><span class=n>null</span><span class=p>)</span> 
</code></pre></div></li><li><p>5th argument - this argument is the result of the previous decryption process our <code>CallbackFunction</code> performed. According to the <a href=https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-zwcreatekey target=_blank rel="noopener noreffer">documentation</a> of <code>ZwCreateKey</code>, this is the <code>Class</code> parameter, that should point to a Unicode string that contains the key&rsquo;s object class (this information should be used by the configuration manager). We have to say that its purpose is not entirely clear from the documentation, but a few articles online mentioned that this should be a Unicode value that will be written to the registry key in some form (<a href=https://wenku.baidu.com/view/574d392458fb770bf78a5501.html target=_blank rel="noopener noreffer">here</a> for example). Debugging this, we see the value is <code>H@n $h0t FiRst!</code>.</p><div class=highlight><pre class=chroma><code class=language-cpp data-lang=cpp><span class=n>kd</span><span class=o>&gt;</span> <span class=n>dq</span> <span class=n>rsp</span><span class=o>+</span><span class=mi>4</span><span class=o>*</span><span class=mi>8</span> <span class=n>l1</span>
<span class=n>fffffc81</span><span class=err>`</span><span class=n>c81e70e0</span>  <span class=n>fffffc81</span><span class=err>`</span><span class=n>c81e7168</span>
<span class=n>kd</span><span class=o>&gt;</span> <span class=n>dt</span> <span class=n>nt</span><span class=o>!</span><span class=n>_UNICODE_STRING</span> <span class=n>fffffc81</span><span class=err>`</span><span class=n>c81e7168</span>
 <span class=s>&#34;H@n $h0t FiRst!&#34;</span>
   <span class=o>+</span><span class=mh>0x000</span> <span class=nl>Length</span>           <span class=p>:</span> <span class=mh>0x1e</span>
   <span class=o>+</span><span class=mh>0x002</span> <span class=nl>MaximumLength</span>    <span class=p>:</span> <span class=mh>0x20</span>
   <span class=o>+</span><span class=mh>0x008</span> <span class=nl>Buffer</span>           <span class=p>:</span> <span class=mh>0xfffffc81</span><span class=err>`</span><span class=n>c81e7330</span>  <span class=s>&#34;H@n $h0t FiRst!&#34;</span>
</code></pre></div></li></ul><p>Finally, the <code>CallbackFunction</code> will simply create a new system thread, that&rsquo;ll unload the driver.</p><div class=highlight><pre class=chroma><code class=language-cpp data-lang=cpp><span class=n>v7</span> <span class=o>=</span> <span class=n>PsCreateSystemThread</span><span class=p>(</span>
                 <span class=o>&amp;</span><span class=n>ThreadHandle</span><span class=p>,</span>
                 <span class=mh>0x10000000u</span><span class=p>,</span>
                 <span class=o>&amp;</span><span class=n>ThreadObjectAttributes</span><span class=p>,</span>
                 <span class=mi>0</span><span class=n>i64</span><span class=p>,</span>
                 <span class=mi>0</span><span class=n>i64</span><span class=p>,</span>
                 <span class=p>(</span><span class=n>PKSTART_ROUTINE</span><span class=p>)</span><span class=n>CallbackContext</span><span class=o>-&gt;</span><span class=n>DriverUnload</span><span class=p>,</span>
                 <span class=n>CallbackContext</span><span class=p>);</span>
</code></pre></div><p>Due to this fact, it&rsquo;s probably a good idea to leave the driver and return to the binary we started from.</p><p>So, let us come back to <code>crackinstaller</code> to see what&rsquo;s going on in its <code>main</code>. Having the ability to easily debug this function, we can focus on the API functions that <code>main</code> uses for its functionality.</p><div class=highlight><pre class=chroma><code class=language-cpp data-lang=cpp><span class=n>SHGetKnownFolderPath</span><span class=p>(</span><span class=o>&amp;</span><span class=n>rfid</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ppszPath</span><span class=p>)</span> <span class=p>)</span>
<span class=n>v13</span> <span class=o>=</span> <span class=n>CreateFileW</span><span class=p>(</span><span class=n>FileName</span><span class=p>,</span> <span class=mh>0xC0000000</span><span class=p>,</span> <span class=mi>3u</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>,</span> <span class=mi>2u</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>);</span>
<span class=n>WriteFile</span><span class=p>(</span><span class=n>v13</span><span class=p>,</span> <span class=n>v4</span><span class=p>,</span> <span class=mh>0x1A600u</span><span class=p>,</span> <span class=p>(</span><span class=n>LPDWORD</span><span class=p>)</span><span class=o>&amp;</span><span class=n>NumberOfBytesWritten</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>)</span>
<span class=n>v22</span> <span class=o>=</span> <span class=n>LoadLibraryW</span><span class=p>(</span><span class=n>LibFileName</span><span class=p>);</span>
<span class=n>v23</span> <span class=o>=</span> <span class=p>(</span><span class=k>const</span> <span class=n>CHAR</span> <span class=o>*</span><span class=p>)</span><span class=n>sub_140001BC8</span><span class=p>(</span><span class=o>&amp;</span><span class=n>unk_140019970</span><span class=p>,</span> <span class=mi>18</span><span class=n>i64</span><span class=p>);</span>
<span class=n>v24</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=kt>void</span><span class=p>))</span><span class=n>GetProcAddress</span><span class=p>(</span><span class=n>v22</span><span class=p>,</span> <span class=n>v23</span><span class=p>);</span>
<span class=n>v24</span><span class=p>();</span>
</code></pre></div><p>We stripped the function down to the bare minimum so the functionality will be better visible.</p><ol><li><p>Looking at the value of <code>rfid</code> and based on the known folder id <a href=https://docs.microsoft.com/en-us/windows/win32/shell/knownfolderid target=_blank rel="noopener noreffer">documentation</a>, we understand that the challenge gets the path of <code>System32</code></p></li><li><p>Next, the binary will create and write to a file in this folder. Now actual need to understand where the data comes from since we can simply execute is and grab the file it drops. We will look at <code>sub_140001C6C</code> which simply decrypts a string at <code>unk_140019A18</code> like we saw before and converts it to a wide string.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>malduck</span> <span class=kn>import</span> <span class=n>unhex</span><span class=p>,</span> <span class=n>xor</span>
<span class=n>key</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;&lt;g~{&lt;it&#34;</span>
<span class=n>data</span> <span class=o>=</span> <span class=n>unhex</span><span class=p>(</span><span class=s2>&#34;602A17184E060753010A277F1B115802100F5508184F3B1D09590D3C590B0E1E4E4710500B7E&#34;</span><span class=p>)</span>
<span class=n>xor</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>

<span class=c1># Result</span>
<span class=c1># b&#39;\\Microsoft\\Credentials\\credHelper.dll\x00&#39;</span>
</code></pre></div><p>You can also use a monitoring tool like <code>procmon</code> to see immediately what is the dumped file.</p></li><li><p>Finally, the binary will decrypt another string from <code>unk_140019970</code>, will get the address of a function with that name from our <code>credHelper.dll</code>, and invoke it.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>xor</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>unhex</span><span class=p>(</span><span class=s2>&#34;780B1229590E1D4F131B096F0C064A020C7B&#34;</span><span class=p>))</span>
<span class=c1># Result</span>
<span class=c1># b&#39;DllRegisterServer\x00&#39;</span>
</code></pre></div></li></ol><p>Sound like we&rsquo;re going into yet another binary!</p><h3 id=credhelperdll>credHelper.dll</h3><p>This DLL has quite a lot of code in it, but no need to think about it, we&rsquo;re heading straight to <code>DllRegisterServer</code>.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>HRESULT</span> <span class=n>__stdcall</span> <span class=n>DllRegisterServer</span><span class=p>()</span>
<span class=p>{</span>
  <span class=n>sub_180003220</span><span class=p>(</span><span class=n>Filename</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>,</span> <span class=mi>512</span><span class=n>i64</span><span class=p>);</span>
  <span class=n>sub_180003220</span><span class=p>(</span><span class=n>sz</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>,</span> <span class=mi>258</span><span class=n>i64</span><span class=p>);</span>
  <span class=n>sub_180003220</span><span class=p>(</span><span class=n>v17</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>,</span> <span class=mi>498</span><span class=n>i64</span><span class=p>);</span>
  <span class=n>v8</span> <span class=o>=</span> <span class=mi>7471205</span><span class=p>;</span>
  <span class=o>*</span><span class=p>(</span><span class=n>_OWORD</span> <span class=o>*</span><span class=p>)</span><span class=n>Data</span> <span class=o>=</span> <span class=n>xmmword_180017790</span><span class=p>;</span>
  <span class=n>v9</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=n>v11</span> <span class=o>=</span> <span class=mi>116</span><span class=p>;</span>
  <span class=o>*</span><span class=p>(</span><span class=n>_OWORD</span> <span class=o>*</span><span class=p>)</span><span class=n>v10</span> <span class=o>=</span> <span class=n>xmmword_1800177A8</span><span class=p>;</span>
  <span class=n>v19</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=n>GetModuleFileNameW</span><span class=p>(</span><span class=n>hModule</span><span class=p>,</span> <span class=n>Filename</span><span class=p>,</span> <span class=mh>0xFF</span><span class=n>u</span><span class=p>);</span>
  <span class=n>v0</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=n>i64</span><span class=p>;</span>
  <span class=n>do</span>
    <span class=o>++</span><span class=n>v0</span><span class=p>;</span>
  <span class=k>while</span> <span class=p>(</span> <span class=n>Filename</span><span class=p>[</span><span class=n>v0</span><span class=p>]</span> <span class=p>);</span>
  <span class=n>v1</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>v0</span> <span class=o>+</span> <span class=mi>2</span><span class=p>;</span>
  <span class=n>StringFromGUID2</span><span class=p>(</span><span class=o>&amp;</span><span class=n>rguid</span><span class=p>,</span> <span class=n>sz</span><span class=p>,</span> <span class=mi>129</span><span class=p>);</span>
  <span class=n>v2</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>v13</span><span class=p>;</span>
  <span class=n>v15</span> <span class=o>=</span> <span class=mi>6029380</span><span class=p>;</span>
  <span class=n>v16</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=o>*</span><span class=p>(</span><span class=n>_QWORD</span> <span class=o>*</span><span class=p>)</span><span class=n>SubKey</span> <span class=o>=</span> <span class=mh>0x490053004C0043</span><span class=n>i64</span><span class=p>;</span>
  <span class=n>do</span>
    <span class=o>++</span><span class=n>v2</span><span class=p>;</span>
  <span class=k>while</span> <span class=p>(</span> <span class=o>*</span><span class=n>v2</span> <span class=p>);</span>
  <span class=n>v3</span> <span class=o>=</span> <span class=mi>0</span><span class=n>i64</span><span class=p>;</span>
  <span class=n>do</span>
  <span class=p>{</span>
    <span class=n>v4</span> <span class=o>=</span> <span class=n>sz</span><span class=p>[</span><span class=n>v3</span><span class=p>];</span>
    <span class=n>v2</span><span class=p>[</span><span class=n>v3</span><span class=o>++</span><span class=p>]</span> <span class=o>=</span> <span class=n>v4</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>while</span> <span class=p>(</span> <span class=n>v4</span> <span class=p>);</span>
  <span class=n>v5</span> <span class=o>=</span> <span class=n>RegCreateKeyExW</span><span class=p>(</span><span class=n>HKEY_CLASSES_ROOT</span><span class=p>,</span> <span class=n>SubKey</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0xF003F</span><span class=n>u</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>hKey</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span> <span class=n>v5</span>
    <span class=o>||</span> <span class=p>(</span><span class=n>v5</span> <span class=o>=</span> <span class=n>RegSetValueExW</span><span class=p>(</span><span class=n>hKey</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=n>u</span><span class=p>,</span> <span class=n>Data</span><span class=p>,</span> <span class=mh>0x16</span><span class=n>u</span><span class=p>))</span> <span class=o>!=</span> <span class=mi>0</span>
    <span class=o>||</span> <span class=p>(</span><span class=n>v5</span> <span class=o>=</span> <span class=n>RegCreateKeyExW</span><span class=p>(</span><span class=n>hKey</span><span class=p>,</span> <span class=n>L</span><span class=s2>&#34;InProcServer32&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0xF003F</span><span class=n>u</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>phkResult</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>))</span> <span class=o>!=</span> <span class=mi>0</span>
    <span class=o>||</span> <span class=p>(</span><span class=n>v5</span> <span class=o>=</span> <span class=n>RegCreateKeyExW</span><span class=p>(</span><span class=n>hKey</span><span class=p>,</span> <span class=n>L</span><span class=s2>&#34;Config&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0xF003F</span><span class=n>u</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>v22</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>))</span> <span class=o>!=</span> <span class=mi>0</span>
    <span class=o>||</span> <span class=p>(</span><span class=n>v5</span> <span class=o>=</span> <span class=n>RegSetValueExW</span><span class=p>(</span><span class=n>phkResult</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=n>u</span><span class=p>,</span> <span class=p>(</span><span class=n>const</span> <span class=n>BYTE</span> <span class=o>*</span><span class=p>)</span><span class=n>Filename</span><span class=p>,</span> <span class=n>v1</span><span class=p>))</span> <span class=o>!=</span> <span class=mi>0</span>
    <span class=o>||</span> <span class=p>(</span><span class=n>v5</span> <span class=o>=</span> <span class=n>RegSetValueExW</span><span class=p>(</span><span class=n>phkResult</span><span class=p>,</span> <span class=n>L</span><span class=s2>&#34;ThreadingModel&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=n>u</span><span class=p>,</span> <span class=n>v10</span><span class=p>,</span> <span class=mh>0x14</span><span class=n>u</span><span class=p>))</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>)</span>
  <span class=p>{</span>
    <span class=n>result</span> <span class=o>=</span> <span class=p>(</span><span class=n>unsigned</span> <span class=n>__int16</span><span class=p>)</span><span class=n>v5</span> <span class=o>|</span> <span class=mh>0x80070000</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span> <span class=n>v5</span> <span class=o>&lt;=</span> <span class=mi>0</span> <span class=p>)</span>
      <span class=n>result</span> <span class=o>=</span> <span class=n>v5</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>else</span>
  <span class=p>{</span>
    <span class=n>RegSetValueExW</span><span class=p>(</span><span class=n>v22</span><span class=p>,</span> <span class=n>L</span><span class=s2>&#34;Password&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=n>u</span><span class=p>,</span> <span class=p>(</span><span class=n>const</span> <span class=n>BYTE</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>v19</span><span class=p>,</span> <span class=mi>2</span><span class=n>u</span><span class=p>);</span>
    <span class=n>RegSetValueExW</span><span class=p>(</span><span class=n>v22</span><span class=p>,</span> <span class=n>L</span><span class=s2>&#34;Flag&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=n>u</span><span class=p>,</span> <span class=p>(</span><span class=n>const</span> <span class=n>BYTE</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>v19</span><span class=p>,</span> <span class=mi>2</span><span class=n>u</span><span class=p>);</span>
    <span class=n>result</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>This function does what a lot of <code>DllRegisterServer</code> function do; creating a key under the classes root in the register, defining their configuration and their server type and threading model. But after that, we have something that seems very interesting. <code>credHelper</code> creates more registry keys there - <code>Password</code> and <code>Flag</code>. Let&rsquo;s try to see if this COM server does operate on those keys somewhere in the code.</p><a class=lightgallery href=/posts/flare-on7-crackinstaller/images/image_1.png title=/posts/flare-on7-crackinstaller/images/image_1.png data-thumbnail=/posts/flare-on7-crackinstaller/images/image_1.png><img class=lazyload src=/svg/loading.min.svg data-src=images/image_1.png data-srcset="/posts/flare-on7-crackinstaller/images/image_1.png, images/image_1.png 1.5x, /posts/flare-on7-crackinstaller/images/image_1.png 2x" data-sizes=auto alt=/posts/flare-on7-crackinstaller/images/image_1.png></a>
<a class=lightgallery href=/posts/flare-on7-crackinstaller/images/image_2.png title=/posts/flare-on7-crackinstaller/images/image_2.png data-thumbnail=/posts/flare-on7-crackinstaller/images/image_2.png><img class=lazyload src=/svg/loading.min.svg data-src=images/image_2.png data-srcset="/posts/flare-on7-crackinstaller/images/image_2.png, images/image_2.png 1.5x, /posts/flare-on7-crackinstaller/images/image_2.png 2x" data-sizes=auto alt=/posts/flare-on7-crackinstaller/images/image_2.png></a><p>We indeed see more functions that use those strings. Let&rsquo;s examine those. Our assumption now is that we can set an appropriate password, and then the COM server will decrypt the flag using the password and set it flag for us. Let&rsquo;s rename <code>sub_18000153C</code> to <code>GetPassword</code> and <code>sub_1800016D8</code> to <code>SetFlag</code>. We have a few options to approach this. One is to simply execute the functions and let them do their thing, which will get us the flag. This can be done using IDA&rsquo;s <a href=https://www.hex-rays.com/blog/practical-appcall-examples/ target=_blank rel="noopener noreffer">Appcall</a>, or even by writing a simple C program that gets the function pointers based on their offset in the DLL and invokes them.</p><p>Another option, which we chose here, is to understand what those two functions are doing and decrypt the flag using the known password</p><h3 id=understanding-getpassword-and-setflag>Understanding <code>GetPassword</code> and <code>SetFlag</code></h3><div class=highlight><pre class=chroma><code class=language-cpp data-lang=cpp><span class=kr>__int64</span> <span class=kr>__fastcall</span> <span class=nf>GetPassword</span><span class=p>(</span><span class=kr>__int64</span> <span class=n>a1</span><span class=p>,</span> <span class=n>_WORD</span> <span class=o>*</span><span class=n>a2</span><span class=p>)</span>
<span class=p>{</span>
  <span class=n>sub_180003220</span><span class=p>(</span><span class=n>pvData</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>,</span> <span class=mi>1040</span><span class=n>i64</span><span class=p>);</span>
  <span class=n>sub_180003220</span><span class=p>(</span><span class=n>SubKey</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>,</span> <span class=mi>512</span><span class=n>i64</span><span class=p>);</span>
  <span class=n>sub_180003220</span><span class=p>(</span><span class=n>sz</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>,</span> <span class=mi>258</span><span class=n>i64</span><span class=p>);</span>
  <span class=n>StringFromGUID2</span><span class=p>(</span><span class=o>&amp;</span><span class=n>rguid</span><span class=p>,</span> <span class=n>sz</span><span class=p>,</span> <span class=mi>129</span><span class=p>);</span>
  <span class=n>wsprintfW</span><span class=p>(</span><span class=n>SubKey</span><span class=p>,</span> <span class=sa>L</span><span class=s>&#34;%s</span><span class=se>\\</span><span class=s>%s</span><span class=se>\\</span><span class=s>%s&#34;</span><span class=p>,</span> <span class=sa>L</span><span class=s>&#34;CLSID&#34;</span><span class=p>,</span> <span class=n>sz</span><span class=p>,</span> <span class=sa>L</span><span class=s>&#34;Config&#34;</span><span class=p>);</span>
  <span class=n>v3</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span> <span class=n>RegGetValueW</span><span class=p>(</span><span class=n>HKEY_CLASSES_ROOT</span><span class=p>,</span> <span class=n>SubKey</span><span class=p>,</span> <span class=sa>L</span><span class=s>&#34;Password&#34;</span><span class=p>,</span> <span class=mi>2u</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>,</span> <span class=n>pvData</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>pcbData</span><span class=p>)</span> <span class=p>)</span>
    <span class=k>return</span> <span class=mh>0x80004005</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span> <span class=n>pcbData</span> <span class=o>&lt;=</span> <span class=mi>2</span> <span class=p>)</span>
    <span class=k>return</span> <span class=mh>0x80004005</span><span class=p>;</span>
  <span class=n>v4</span> <span class=o>=</span> <span class=n>sub_180005A2C</span><span class=p>(</span><span class=n>v20</span><span class=p>,</span> <span class=n>pvData</span><span class=p>,</span> <span class=mi>260</span><span class=n>i64</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span> <span class=n>v4</span> <span class=o>==</span> <span class=mi>260</span> <span class=o>||</span> <span class=n>v4</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span> <span class=p>)</span>
    <span class=k>return</span> <span class=mh>0x80004005</span><span class=p>;</span>
  <span class=n>v5</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)(</span><span class=n>a2</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
  <span class=o>*</span><span class=n>a2</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=n>v6</span> <span class=o>=</span> <span class=n>a2</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
  <span class=n>LOBYTE</span><span class=p>(</span><span class=n>v7</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=n>v8</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=n>v9</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=n>v10</span> <span class=o>=</span> <span class=mh>0x100</span><span class=n>i64</span><span class=p>;</span>
  <span class=k>do</span>
    <span class=o>*</span><span class=n>v6</span><span class=o>++</span> <span class=o>=</span> <span class=n>v9</span><span class=o>++</span><span class=p>;</span>
  <span class=k>while</span> <span class=p>(</span> <span class=n>v9</span> <span class=o>&lt;</span> <span class=mh>0x100</span> <span class=p>);</span>
  <span class=n>v11</span> <span class=o>=</span> <span class=n>v4</span><span class=p>;</span>
  <span class=n>v12</span> <span class=o>=</span> <span class=mi>0</span><span class=n>i64</span><span class=p>;</span>
  <span class=n>v13</span> <span class=o>=</span> <span class=n>v5</span><span class=p>;</span>
  <span class=k>do</span>
  <span class=p>{</span>
    <span class=n>v14</span> <span class=o>=</span> <span class=o>*</span><span class=n>v13</span><span class=p>;</span>
    <span class=n>v15</span> <span class=o>=</span> <span class=n>v12</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
    <span class=n>v16</span> <span class=o>=</span> <span class=n>v20</span><span class=p>[</span><span class=n>v12</span><span class=p>];</span>
    <span class=n>v12</span> <span class=o>=</span> <span class=mi>0</span><span class=n>i64</span><span class=p>;</span>
    <span class=n>v7</span> <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kr>__int8</span><span class=p>)(</span><span class=n>v7</span> <span class=o>+</span> <span class=o>*</span><span class=n>v13</span> <span class=o>+</span> <span class=n>v16</span><span class=p>);</span>
    <span class=o>*</span><span class=n>v13</span><span class=o>++</span> <span class=o>=</span> <span class=n>v5</span><span class=p>[</span><span class=n>v7</span><span class=p>];</span>
    <span class=n>v5</span><span class=p>[</span><span class=n>v7</span><span class=p>]</span> <span class=o>=</span> <span class=n>v14</span><span class=p>;</span>
    <span class=n>v17</span> <span class=o>=</span> <span class=n>v8</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
    <span class=n>v8</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span> <span class=n>v15</span> <span class=o>&lt;</span> <span class=n>v11</span> <span class=p>)</span>
      <span class=n>v8</span> <span class=o>=</span> <span class=n>v17</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span> <span class=n>v15</span> <span class=o>&lt;</span> <span class=n>v11</span> <span class=p>)</span>
      <span class=n>v12</span> <span class=o>=</span> <span class=n>v15</span><span class=p>;</span>
    <span class=o>--</span><span class=n>v10</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>while</span> <span class=p>(</span> <span class=n>v10</span> <span class=p>);</span>
  <span class=k>return</span> <span class=n>v3</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>When trying to identify an encryption/decryption algorithm, it&rsquo;s always a good idea to search for known crypto constants. A great way to do that is using the IDA plugin - <em><a href=https://github.com/polymorf/findcrypt-yara target=_blank rel="noopener noreffer">FindCrypt</a>.</em> Having said that, in this case, there are no such constants. What we do see in this function is, first of all, the usage of <code>RegGetValueW</code> to read our password from the registry. Secondly, we see two loops that iterate <code>0x100</code> times each. At this point, we should immediately suspect that RC4 is involved. If you didn&rsquo;t realize that, we encourage you to read this <a href=https://blog.talosintelligence.com/2014/06/an-introduction-to-recognizing-and.html target=_blank rel="noopener noreffer">article</a> published by Talos on how to identify RC4 in malware. It explains quite thoroughly how this encryption method works and what to look for while reverse engineering. The part we see here looks like the creation of the substitution box for the decryption.</p><div class=highlight><pre class=chroma><code class=language-cpp data-lang=cpp><span class=kr>__int64</span> <span class=kr>__fastcall</span> <span class=nf>SetFlag</span><span class=p>(</span><span class=kr>__int64</span> <span class=n>a1</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kr>__int8</span> <span class=o>*</span><span class=n>a2</span><span class=p>)</span>
<span class=p>{</span>
  <span class=n>v3</span> <span class=o>=</span> <span class=o>-</span><span class=mi>2147467259</span><span class=p>;</span>
  <span class=n>sub_180003220</span><span class=p>(</span><span class=n>SubKey</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>,</span> <span class=mi>512</span><span class=n>i64</span><span class=p>);</span>
  <span class=n>sub_180003220</span><span class=p>(</span><span class=n>sz</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>,</span> <span class=mi>258</span><span class=n>i64</span><span class=p>);</span>
  <span class=n>v14</span> <span class=o>=</span> <span class=mi>0</span><span class=n>i64</span><span class=p>;</span>
  <span class=n>v15</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=n>v16</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=o>*</span><span class=p>(</span><span class=n>_OWORD</span> <span class=o>*</span><span class=p>)</span><span class=n>Source</span> <span class=o>=</span> <span class=mi>0</span><span class=n>i64</span><span class=p>;</span>
  <span class=n>v13</span> <span class=o>=</span> <span class=mi>0</span><span class=n>i64</span><span class=p>;</span>
  <span class=n>sub_180003220</span><span class=p>(</span><span class=n>Data</span><span class=p>,</span> <span class=mi>0</span><span class=n>i64</span><span class=p>,</span> <span class=mi>180</span><span class=n>i64</span><span class=p>);</span>
  <span class=n>v4</span> <span class=o>=</span> <span class=o>*</span><span class=n>a2</span><span class=p>;</span>
  <span class=n>v5</span> <span class=o>=</span> <span class=mi>0</span><span class=n>i64</span><span class=p>;</span>
  <span class=n>v6</span> <span class=o>=</span> <span class=n>a2</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
  <span class=k>do</span>
  <span class=p>{</span>
    <span class=n>v7</span> <span class=o>=</span> <span class=n>a2</span><span class=p>[</span><span class=o>++</span><span class=n>v4</span> <span class=o>+</span> <span class=mi>2</span><span class=p>];</span>
    <span class=n>v6</span> <span class=o>+=</span> <span class=n>v7</span><span class=p>;</span>
    <span class=n>v8</span> <span class=o>=</span> <span class=n>a2</span><span class=p>[</span><span class=n>v6</span> <span class=o>+</span> <span class=mi>2</span><span class=p>];</span>
    <span class=n>a2</span><span class=p>[</span><span class=n>v4</span> <span class=o>+</span> <span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>v8</span><span class=p>;</span>
    <span class=n>a2</span><span class=p>[</span><span class=n>v6</span> <span class=o>+</span> <span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>v7</span><span class=p>;</span>
    <span class=n>Source</span><span class=p>[</span><span class=n>v5</span><span class=p>]</span> <span class=o>=</span> <span class=n>byte_18001A9F0</span><span class=p>[</span><span class=n>v5</span><span class=p>]</span> <span class=o>^</span> <span class=n>a2</span><span class=p>[(</span><span class=kt>unsigned</span> <span class=kr>__int8</span><span class=p>)(</span><span class=n>v7</span> <span class=o>+</span> <span class=n>v8</span><span class=p>)</span> <span class=o>+</span> <span class=mi>2</span><span class=p>];</span>
    <span class=o>++</span><span class=n>v5</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>while</span> <span class=p>(</span> <span class=n>v5</span> <span class=o>&lt;</span> <span class=mh>0x2C</span> <span class=p>);</span>
  <span class=o>*</span><span class=n>a2</span> <span class=o>=</span> <span class=n>v4</span><span class=p>;</span>
  <span class=n>a2</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>v6</span><span class=p>;</span>
  <span class=n>v9</span> <span class=o>=</span> <span class=n>mbstowcs</span><span class=p>(</span><span class=n>Data</span><span class=p>,</span> <span class=n>Source</span><span class=p>,</span> <span class=mh>0x2Du</span><span class=n>i64</span><span class=p>);</span>
  <span class=n>v10</span> <span class=o>=</span> <span class=n>v9</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span> <span class=n>v9</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=n>v9</span> <span class=o>!=</span> <span class=mi>45</span> <span class=p>)</span>
  <span class=p>{</span>
    <span class=n>StringFromGUID2</span><span class=p>(</span><span class=o>&amp;</span><span class=n>rguid</span><span class=p>,</span> <span class=n>sz</span><span class=p>,</span> <span class=mi>129</span><span class=p>);</span>
    <span class=n>wsprintfW</span><span class=p>(</span><span class=n>SubKey</span><span class=p>,</span> <span class=sa>L</span><span class=s>&#34;%s</span><span class=se>\\</span><span class=s>%s</span><span class=se>\\</span><span class=s>%s&#34;</span><span class=p>,</span> <span class=sa>L</span><span class=s>&#34;CLSID&#34;</span><span class=p>,</span> <span class=n>sz</span><span class=p>,</span> <span class=sa>L</span><span class=s>&#34;Config&#34;</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span> <span class=o>!</span><span class=n>RegOpenKeyExW</span><span class=p>(</span><span class=n>HKEY_CLASSES_ROOT</span><span class=p>,</span> <span class=n>SubKey</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x20006u</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>hKey</span><span class=p>)</span> <span class=p>)</span>
    <span class=p>{</span>
      <span class=n>RegSetValueExW</span><span class=p>(</span><span class=n>hKey</span><span class=p>,</span> <span class=sa>L</span><span class=s>&#34;Flag&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1u</span><span class=p>,</span> <span class=p>(</span><span class=k>const</span> <span class=n>BYTE</span> <span class=o>*</span><span class=p>)</span><span class=n>Data</span><span class=p>,</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>v10</span><span class=p>);</span>
      <span class=n>v3</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>v3</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>In <code>SetFlag</code>, we see a loop that uses constant bytes from <code>byte_18001A9F0</code>. After the loop, the result of this decryption is written to our <code>Flag</code> registry key, using <code>RegSetValueEx</code>. This must be our encrypted flag!</p><p>Let&rsquo;s apply RC4 decryption to these bytes and see if we identified the algorithm correctly.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>malduck</span> <span class=kn>import</span> <span class=n>rc4</span><span class=p>,</span> <span class=n>unhex</span>

<span class=n>flag</span> <span class=o>=</span> <span class=n>unhex</span><span class=p>(</span><span class=s2>&#34;1656BC869EE1D10265C1699F100AACC1F6E9FDB4CD224A359C1273BD2B1054B943D2139A8465ADB0BF5A811000000000&#34;</span><span class=p>)</span>
<span class=n>key</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;H@n $h0t FiRst!&#34;</span>
<span class=n>rc4</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>flag</span><span class=p>)</span>

<span class=c1># Result</span>
<span class=c1># b&#39;S0_m@ny_cl@sse$_in_th3_Reg1stry@flare-on.com\xe8\x9d\x92A&#39;</span>
</code></pre></div><p>Got it! The flag is <code>S0_m@ny_cl@sse$_in_th3_Reg1stry@flare-on.com</code>.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2020-10-23</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/flare-on/>flare-on</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/flare-on7-aardvark/ class=prev rel=prev title="Flare-On 7 — 08 Aardvark"><i class="fas fa-angle-left fa-fw"></i>Flare-On 7 — 08 Aardvark</a>
<a href=/posts/flare-on-7-break/ class=next rel=next title="Flare-On 7 — 10 Break">Flare-On 7 — 10 Break<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.76.5">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i>LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2020</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":60},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true}};</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-Z0NYXY577C');</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-Z0NYXY577C" async></script></body></html>